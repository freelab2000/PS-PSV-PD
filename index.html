<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PSV/PS/PD</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js");
      });
    }
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    .time-group { display: flex; gap: 10px; }
    .time-group input { width: 50%; }
    button { margin-top: 20px; padding: 10px 20px; }
    .resultado { margin-top: 25px; font-weight: bold; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>PSV/PS/PD</h1>

  <label for="tripulacion">Tipo de Tripulaci√≥n:</label>
  <select id="tripulacion">
    <option value="2">2 pilotos</option>
    <option value="3">3 pilotos</option>
    <option value="4">4 pilotos</option>
  </select>

  <label>Inicio PSV:</label>
  <div class="time-group">
    <input type="number" id="inicioHora" placeholder="HH" min="0" max="23">
    <input type="number" id="inicioMin" placeholder="MM" min="0" max="59">
  </div>

  <label>T√©rmino PSV:</label>
  <div class="time-group">
    <input type="number" id="finHora" placeholder="HH" min="0" max="23">
    <input type="number" id="finMin" placeholder="MM" min="0" max="59">
  </div>

  <label for="origen">Aeropuerto de Origen:</label>
  <select id="origen"></select>

  <label for="destino">Aeropuerto de Destino:</label>
  <select id="destino"></select>

  <label for="tiempoVuelo">Tiempo de Vuelo (HH:MM):</label>
  <input type="text" id="tiempoVuelo" placeholder="ej. 07:45">

  <button onclick="validarPSV()">Validar</button>

  <div class="resultado" id="resultado"></div>

  <script>
    const aeropuertos = {
      SCEL: { name: "Arturo Merino Ben√≠tez (Santiago)", lon: -70.785 },
      SCFA: { name: "Cerro Moreno (Antofagasta)", lon: -70.4314 },
      SCDA: { name: "Diego Aracena (Iquique)", lon: -70.1814 },
      SPJC: { name: "Jorge Ch√°vez (Lima)", lon: -77.1144 },
      SPHI: { name: "Capit√°n FAP Jos√© A. Qui√±ones (Chiclayo)", lon: -79.8281 },
      SEGU: { name: "Jos√© Joaqu√≠n de Olmedo (Guayaquil)", lon: -79.8836 },
      SEQM: { name: "Mariscal Sucre (Quito)", lon: -78.3575 },
      SKBO: { name: "El Dorado (Bogot√°)", lon: -74.1469 },
      SKCL: { name: "Alfonso Bonilla Arag√≥n (Cali)", lon: -76.3858 },
      MPTO: { name: "Tocumen (Panam√°)", lon: -79.3832 },
      KMIA: { name: "Miami International", lon: -80.2906 },
      EHAM: { name: "Schiphol (Amsterdam)", lon: 4.7639 },
      EBBR: { name: "Brussels Airport", lon: 4.4844 },
      EDDF: { name: "Frankfurt am Main", lon: 8.5706 },
      GVAC: { name: "Am√≠lcar Cabral (Sal)", lon: -22.9494 },
      SBKP: { name: "Viracopos (Campinas)", lon: -47.1345 },
      SBRF: { name: "Guararapes (Recife)", lon: -34.9181 },
      SBGR: { name: "Guarulhos (S√£o Paulo)", lon: -46.4695 },
      SAEZ: { name: "Ezeiza (Buenos Aires)", lon: -58.5358 },
      SACO: { name: "C√≥rdoba", lon: -64.208 },
      SCIE: { name: "Carriel Sur (Concepci√≥n)", lon: -73.06 },
      SAME: { name: "Mendoza", lon: -68.7728 },
      KJFK: { name: "John F. Kennedy (NY)", lon: -73.7781 },
      KMCO: { name: "Orlando International", lon: -81.3081 },
      KLAX: { name: "Los Angeles", lon: -118.4081 },
      SKRG: { name: "Medell√≠n", lon: -75.4231 },
      MUHA: { name: "Jos√© Mart√≠ (Havana)", lon: -82.4092 },
      KRSW: { name: "Fort Myers", lon: -81.7552 },
      KPBI: { name: "Palm Beach", lon: -80.09 },
      KFLL: { name: "Ft. Lauderdale", lon: -80.1527 },
      KBOS: { name: "Boston Logan", lon: -71.0052 },
      KBGR: { name: "Bangor", lon: -68.8281 },
      CYZX: { name: "Greenwood (CA)", lon: -64.9225 },
      CYHZ: { name: "Halifax", lon: -63.5086 },
      CYQM: { name: "Moncton", lon: -64.6786 },
      CYJT: { name: "Stephenville", lon: -58.5506 },
      CYQX: { name: "Gander", lon: -54.5681 },
      LPLA: { name: "Lajes (Azores)", lon: -28.4294 },
      LPAZ: { name: "Santa Maria (Azores)", lon: -28.0503 },
      LPPT: { name: "Lisboa", lon: -9.1359 },
      LEMD: { name: "Madrid Barajas", lon: -3.5642 },
      GCLP: { name: "Gran Canaria", lon: -15.4706 },
      GCTS: { name: "Tenerife Sur", lon: -16.5725 },
      GMMN: { name: "Casablanca", lon: -7.5897 },
      GOBD: { name: "Dakar", lon: -17.0733 },
      GVBA: { name: "Rabil", lon: -22.6661 },
      GVNP: { name: "Praia", lon: -23.4833 },
      GVSV: { name: "S√£o Vicente", lon: -25.0581 },
      EHRD: { name: "Rotterdam", lon: 4.4372 },
      LEVD: { name: "Valladolid", lon: -4.8519 }
    };

    const descansosPorPSV = [
      { max: 7, descanso: 10 },
      { max: 8, descanso: 12 },
      { max: 9, descanso: 13 },
      { max: 10, descanso: 14 },
      { max: 11, descanso: 15 },
      { max: 12, descanso: 15 },
      { max: 13, descanso: 15 },
      { max: 14, descanso: 17 },
      { max: 15, descanso: 17 },
      { max: 16, descanso: 18 },
      { max: 17, descanso: 19 },
      { max: 18, descanso: 20 },
      { max: 19, descanso: 22 },
      { max: 20, descanso: 24 },
    ];

    function calcularDescansoBase(psvHoras) {
      for (let regla of descansosPorPSV) {
        if (psvHoras <= regla.max) return regla.descanso * 60;
      }
      return 24 * 60;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const selOri = document.getElementById("origen");
      const selDes = document.getElementById("destino");
      const sortedAirports = Object.entries(aeropuertos).sort(([a,], [b,]) => a.localeCompare(b));
      sortedAirports.forEach(([code, info]) => {
        const opt = new Option(`${code} ‚Äì ${info.name}`, code);
        selOri.add(opt.cloneNode(true));
        selDes.add(opt);
      });
    });

    function tiempoEnMinutos(horaStr) {
      const [h, m] = horaStr.split(":").map(Number);
      return h * 60 + m;
    }

    function minutosAHorasYMinutos(minutos) {
      const h = Math.floor(minutos / 60);
      const m = minutos % 60;
      return `${h}h ${m}min`;
    }

    function validarPSV() {
      const tipo = parseInt(document.getElementById("tripulacion").value);
      const ih = parseInt(document.getElementById("inicioHora").value);
      const im = parseInt(document.getElementById("inicioMin").value);
      const fh = parseInt(document.getElementById("finHora").value);
      const fm = parseInt(document.getElementById("finMin").value);
      const vuelo = document.getElementById("tiempoVuelo").value;
      const ori = document.getElementById("origen").value;
      const des = document.getElementById("destino").value;

      if ([ih, im, fh, fm].some(isNaN) || !vuelo || !ori || !des) {
        return document.getElementById("resultado").innerText = "‚ö†Ô∏è Completa todos los campos.";
      }

      let inicio = ih * 60 + im;
      let fin = fh * 60 + fm;
      if (fin < inicio) fin += 1440;

      const durPSV = fin - inicio;
      const vueloMin = tiempoEnMinutos(vuelo);
      const limites = { 2: { hv: 480, psv: 720, ext: 120 }, 3: { hv: 720, psv: 1080, ext: 0 }, 4: { hv: 960, psv: 1200, ext: 0 } };
      const { hv, psv, ext } = limites[tipo];

      const deltaLong = Math.abs(aeropuertos[ori].lon - aeropuertos[des].lon);
      const ajusteDescanso = deltaLong >= 45 ? 120 + Math.floor((deltaLong - 45) / 15) * 30 : 0;

      const descansoBase = calcularDescansoBase(Math.ceil(durPSV / 60));
      const descansoTotal = descansoBase + ajusteDescanso;

      let msg = `üïí PSV: ${minutosAHorasYMinutos(durPSV)}\n`;
      msg += `‚úàÔ∏è Vuelo: ${minutosAHorasYMinutos(vueloMin)}\n`;
      msg += `üåç ŒîLongitud: ${deltaLong.toFixed(2)}¬∞\n`;
      msg += `üõå Descanso m√≠nimo base: ${minutosAHorasYMinutos(descansoBase)}\n`;
      if (ajusteDescanso) {
        msg += `üõå Ajuste por longitud: +${minutosAHorasYMinutos(ajusteDescanso)}\n`;
        msg += `‚úÖ Se ha agregado el per√≠odo de descanso adicional establecido por cambio de longitud geogr√°fica\n`;
      }
      msg += `üõå Descanso total requerido: ${minutosAHorasYMinutos(descansoTotal)}\n\n`;

      msg += durPSV > psv + ext ? `‚ùå PSV excedido (m√°x. ${minutosAHorasYMinutos(psv + ext)})\n` : `‚úÖ PSV dentro de l√≠mite\n`;
      msg += vueloMin > hv ? `‚ùå HV excedido (m√°x. ${minutosAHorasYMinutos(hv)})` : `‚úÖ HV dentro de l√≠mite`;

      document.getElementById("resultado").innerText = msg;
    }
  </script>
</body>
</html>
