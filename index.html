<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PSV/PS/PD</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#004080" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192x192.png" />
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Figtree', sans-serif;
      background: #f5f8fa;
      padding: 20px;
      max-width: 640px;
      margin: auto;
      color: #1a1a1a;
    }
    h1 {
      text-align: center;
      color: #004080;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input, select {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: 5px;
    }
    .time-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      margin-top: 5px;
    }
    select.time { width: 80px; }
    button {
      padding: 10px 14px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #004080;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0059b3;
    }
    
.resultado {
  margin-top: 30px;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  font-size: 16px;
  line-height: 1.6;
  border-left: 5px solid #004080;
}
.resultado span.ok {
  display: inline-block;
  color: #2e7d32;
  font-weight: bold;
}
.resultado span.error {
  display: inline-block;
  color: #d32f2f;
  font-weight: bold;
}
.resultado span.info {
  display: inline-block;
  color: #004080;
  font-weight: 500;
}

    .resultado .error { color: #d32f2f; font-weight: bold; }
    .resultado .info { color: #004080; font-weight: 500; }
    .resultado .section { margin-top: 12px; }
    @media (max-width: 600px) {
      .time-group {
        flex-direction: column;
        align-items: flex-start;
      }
      select.time, button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<h1>PSV/PS/PD</h1>

<label for="tripulacion">Tipo de Tripulaci√≥n:</label>
<select id="tripulacion">
  <option value="2">2 pilotos</option>
  <option value="3">3 pilotos</option>
  <option value="4">4 pilotos</option>
</select>

<label>Inicio PSV:</label>
<div class="time-group">
  <button onclick="ajustar('inicioHora', -1)">‚àí</button>
  <select id="inicioHora" class="time"></select>
  <button onclick="ajustar('inicioHora', 1)">+</button>
  <button onclick="ajustar('inicioMin', -1)">‚àí</button>
  <select id="inicioMin" class="time"></select>
  <button onclick="ajustar('inicioMin', 1)">+</button>
</div>

<label>T√©rmino PSV:</label>
<div class="time-group">
  <button onclick="ajustar('finHora', -1)">‚àí</button>
  <select id="finHora" class="time"></select>
  <button onclick="ajustar('finHora', 1)">+</button>
  <button onclick="ajustar('finMin', -1)">‚àí</button>
  <select id="finMin" class="time"></select>
  <button onclick="ajustar('finMin', 1)">+</button>
</div>

<label for="origen">Aeropuerto de Origen:</label>
<select id="origen"></select>

<label for="destino">Aeropuerto de Destino:</label>
<select id="destino"></select>

<label for="tiempoVuelo">Tiempo de Vuelo (HH:MM):</label>
<input type="text" id="tiempoVuelo" placeholder="ej. 07:45" />

<button onclick="validarPSV()">Validar</button>

<div class="resultado" id="resultado"></div>

<script>

const aeropuertos = {
  SCEL: { name: "Santiago", lon: -70.785 },
  SCFA: { name: "Antofagasta", lon: -70.4314 },
  SCDA: { name: "Iquique", lon: -70.1814 },
  SPJC: { name: "Lima", lon: -77.1144 },
  SPHI: { name: "Chiclayo", lon: -79.8281 },
  SEGU: { name: "Guayaquil", lon: -79.8836 },
  SEQM: { name: "Quito", lon: -78.356 },
  SKBO: { name: "Bogot√°", lon: -74.1469 },
  SKCL: { name: "Cali", lon: -76.3814 },
  MPTO: { name: "Tocumen", lon: -79.3833 },
  KMIA: { name: "Miami", lon: -80.2906 },
  KJFK: { name: "New York JFK", lon: -73.7781 },
  KMCO: { name: "Orlando", lon: -81.3089 },
  KLAX: { name: "Los Angeles", lon: -118.4081 },
  KRSW: { name: "Fort Myers", lon: -81.7551 },
  KPBI: { name: "Palm Beach", lon: -80.0909 },
  KFLL: { name: "Fort Lauderdale", lon: -80.1449 },
  KBOS: { name: "Boston", lon: -71.0052 },
  KBGR: { name: "Bangor", lon: -68.8281 },
  CYZX: { name: "Greenwood", lon: -64.917 },
  CYHZ: { name: "Halifax", lon: -63.5167 },
  CYQM: { name: "Moncton", lon: -64.6786 },
  CYJT: { name: "Stephenville", lon: -58.5500 },
  CYQX: { name: "Gander", lon: -54.5644 },
  LPLA: { name: "Lajes", lon: -28.4294 },
  LPAZ: { name: "Santa Maria", lon: -28.0483 },
  LPPT: { name: "Lisboa", lon: -9.1281 },
  LEMD: { name: "Madrid", lon: -3.5668 },
  GCLP: { name: "Gran Canaria", lon: -15.3846 },
  GCTS: { name: "Tenerife Sur", lon: -16.5725 },
  GMMN: { name: "Casablanca", lon: -7.5899 },
  GOBD: { name: "Dakar", lon: -17.0733 },
  GVBA: { name: "Boa Vista", lon: -22.8016 },
  GVNP: { name: "Praia", lon: -23.4847 },
  GVSV: { name: "S√£o Vicente", lon: -25.0566 },
  EHAM: { name: "Amsterdam", lon: 4.7639 },
  EBBR: { name: "Bruselas", lon: 4.4844 },
  EDDF: { name: "Frankfurt", lon: 8.5706 },
  SAEZ: { name: "Buenos Aires", lon: -58.5378 },
  SAME: { name: "Mendoza", lon: -68.7967 },
  SACO: { name: "C√≥rdoba", lon: -64.208 },
  SBKP: { name: "Campinas", lon: -47.1344 },
  SBRF: { name: "Recife", lon: -34.9156 },
  SBGR: { name: "Guarulhos", lon: -46.4695 },
  SCIE: { name: "Concepci√≥n", lon: -73.0606 },
  EHRD: { name: "Rotterdam", lon: 4.4372 },
  LEVD: { name: "Valladolid", lon: -4.8519 }
};

const descansosPorPSV = [
  { max: 7, descanso: 10 }, { max: 8, descanso: 12 }, { max: 9, descanso: 13 },
  { max: 10, descanso: 14 }, { max: 11, descanso: 15 }, { max: 12, descanso: 15 },
  { max: 13, descanso: 15 }, { max: 14, descanso: 17 }, { max: 15, descanso: 17 },
  { max: 16, descanso: 18 }, { max: 17, descanso: 19 }, { max: 18, descanso: 20 },
  { max: 19, descanso: 22 }, { max: 20, descanso: 24 }
];

function ajustar(id, delta) {
  const sel = document.getElementById(id);
  const max = id.includes("Hora") ? 23 : 59;
  let val = parseInt(sel.value || 0);
  val = (val + delta + (max + 1)) % (max + 1);
  sel.value = String(val).padStart(2, '0');
}

function llenarSelectHorasMinutos() {
  const horas = [...Array(24).keys()].map(h => String(h).padStart(2, '0'));
  const minutos = [...Array(60).keys()].map(m => String(m).padStart(2, '0'));
  for (let id of ["inicioHora", "finHora"]) {
    const sel = document.getElementById(id);
    horas.forEach(h => sel.add(new Option(h, h)));
  }
  for (let id of ["inicioMin", "finMin"]) {
    const sel = document.getElementById(id);
    minutos.forEach(m => sel.add(new Option(m, m)));
  }
  const selOri = document.getElementById("origen");
  const selDes = document.getElementById("destino");
  Object.entries(aeropuertos).sort(([a], [b]) => a.localeCompare(b)).forEach(([code, info]) => {
    const opt = new Option(`${code} ‚Äì ${info.name}`, code);
    selOri.add(opt.cloneNode(true));
    selDes.add(opt);
  });
}

function tiempoEnMinutos(horaStr) {
  const [h, m] = horaStr.split(":").map(Number);
  return h * 60 + m;
}

function minutosAHorasYMinutos(min) {
  const h = Math.floor(min / 60);
  return `${h}h ${min % 60}min`;
}

function calcularDescansoBase(horas) {
  for (let regla of descansosPorPSV) {
    if (horas <= regla.max) return regla.descanso * 60;
  }
  return 24 * 60;
}

function validarPSV() {
  const tipo = parseInt(document.getElementById("tripulacion").value);
  const ih = parseInt(document.getElementById("inicioHora").value);
  const im = parseInt(document.getElementById("inicioMin").value);
  const fh = parseInt(document.getElementById("finHora").value);
  const fm = parseInt(document.getElementById("finMin").value);
  const vuelo = document.getElementById("tiempoVuelo").value;
  const ori = document.getElementById("origen").value;
  const des = document.getElementById("destino").value;
  if ([ih, im, fh, fm].some(isNaN) || !vuelo || !ori || !des)
    return document.getElementById("resultado").innerText = "‚ö†Ô∏è Completa todos los campos.";

  let inicio = ih * 60 + im;
  let fin = fh * 60 + fm;
  if (fin < inicio) fin += 1440;

  const durPSV = fin - inicio;
  const vueloMin = tiempoEnMinutos(vuelo);
  const nocturno = (ih >= 21 || ih < 6);
  const limites = { 2: { hv: 480, psv: 720, ext: 120, noct: 720 }, 3: { hv: 720, psv: 1080 }, 4: { hv: 960, psv: 1200 } };
  const { hv, psv, ext, noct } = limites[tipo];

  const deltaLong = Math.abs(aeropuertos[ori].lon - aeropuertos[des].lon);
  const ajusteDescanso = deltaLong >= 45 ? 120 + Math.floor((deltaLong - 45) / 15) * 30 : 0;
  const descansoBase = calcularDescansoBase(Math.ceil(durPSV / 60));
  const descansoTotal = descansoBase + ajusteDescanso;

  let msg = `üïí PSV: ${minutosAHorasYMinutos(durPSV)}\n`;
  msg += `‚úàÔ∏è Vuelo: ${minutosAHorasYMinutos(vueloMin)}\n`;
  msg += `üåç ŒîLongitud: ${deltaLong.toFixed(2)}¬∞\n`;
  msg += `üõå Descanso m√≠nimo base: ${minutosAHorasYMinutos(descansoBase)}\n`;
  if (ajusteDescanso) {
    msg += `üõå Ajuste por longitud: +${minutosAHorasYMinutos(ajusteDescanso)}\n`;
    msg += `‚úÖ Se ha agregado el per√≠odo de descanso adicional establecido por cambio de longitud geogr√°fica\n`;
  }
  msg += `üõå Descanso total requerido: ${minutosAHorasYMinutos(descansoTotal)}\n\n`;

  if (nocturno && durPSV > (noct || psv)) {
    msg += `‚ùå Restricci√≥n nocturna activa: PSV no puede exceder ${minutosAHorasYMinutos(noct || psv)}\n`;
  } else {
    msg += durPSV > (psv + (ext || 0)) ? `‚ùå PSV excedido (m√°x. ${minutosAHorasYMinutos(psv + (ext || 0))})\n` : `‚úÖ PSV dentro de l√≠mite\n`;
  }

  msg += vueloMin > hv ? `‚ùå HV excedido (m√°x. ${minutosAHorasYMinutos(hv)})` : `‚úÖ HV dentro de l√≠mite`;
  document.getElementById("resultado").innerHTML = msg
    .replace(/‚úÖ/g, '<span class="ok">‚úÖ</span>')
    .replace(/‚ùå/g, '<span class="error">‚ùå</span>')
    .replace(/üõå|‚úàÔ∏è|üïí|üåç|üìò/g, '<span class="info">$&</span>')
    .replace(/\n/g, '<br>');
}

window.addEventListener("DOMContentLoaded", llenarSelectHorasMinutos);

</script>

</body>
</html>
