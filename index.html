<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PSV/PS/PD</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#004080" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192x192.png" />
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js");
      });
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, select, button {
      padding: 8px;
      font-size: 16px;
    }
    .time-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      margin-top: 5px;
    }
    select { width: 70px; }
    button { padding: 6px 12px; }
    .resultado {
      margin-top: 25px;
      font-weight: bold;
      white-space: pre-wrap;
    }
    @media (max-width: 600px) {
      .time-group {
        flex-direction: column;
        align-items: flex-start;
      }
      select, button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <h1>PSV/PS/PD</h1>

  <label for="tripulacion">Tipo de Tripulaci√≥n:</label>
  <select id="tripulacion">
    <option value="2">2 pilotos</option>
    <option value="3">3 pilotos</option>
    <option value="4">4 pilotos</option>
  </select>

  <label>Inicio PSV:</label>
  <div class="time-group">
    <button onclick="ajustar('inicioHora', -1)">‚àí</button>
    <select id="inicioHora"></select>
    <button onclick="ajustar('inicioHora', 1)">+</button>
    <button onclick="ajustar('inicioMin', -1)">‚àí</button>
    <select id="inicioMin"></select>
    <button onclick="ajustar('inicioMin', 1)">+</button>
  </div>

  <label>T√©rmino PSV:</label>
  <div class="time-group">
    <button onclick="ajustar('finHora', -1)">‚àí</button>
    <select id="finHora"></select>
    <button onclick="ajustar('finHora', 1)">+</button>
    <button onclick="ajustar('finMin', -1)">‚àí</button>
    <select id="finMin"></select>
    <button onclick="ajustar('finMin', 1)">+</button>
  </div>

  <label for="origen">Aeropuerto de Origen:</label>
  <select id="origen"></select>

  <label for="destino">Aeropuerto de Destino:</label>
  <select id="destino"></select>

  <label for="tiempoVuelo">Tiempo de Vuelo (HH:MM):</label>
  <input type="text" id="tiempoVuelo" placeholder="ej. 07:45" style="width: 100%;"/>

  <button onclick="validarPSV()">Validar</button>

  <div class="resultado" id="resultado"></div>

  <script>
    const aeropuertos = {
      SCEL: { name: "Santiago", lon: -70.785 },
      SCFA: { name: "Antofagasta", lon: -70.4314 },
      SCDA: { name: "Iquique", lon: -70.1814 },
      SPJC: { name: "Lima", lon: -77.1144 },
      EHAM: { name: "Amsterdam", lon: 4.7639 },
      KMIA: { name: "Miami", lon: -80.2906 }
    };

    const descansosPorPSV = [
      { max: 7, descanso: 10 },
      { max: 8, descanso: 12 },
      { max: 9, descanso: 13 },
      { max: 10, descanso: 14 },
      { max: 11, descanso: 15 },
      { max: 12, descanso: 15 },
      { max: 13, descanso: 15 },
      { max: 14, descanso: 17 },
      { max: 15, descanso: 17 },
      { max: 16, descanso: 18 },
      { max: 17, descanso: 19 },
      { max: 18, descanso: 20 },
      { max: 19, descanso: 22 },
      { max: 20, descanso: 24 }
    ];

    function calcularDescansoBase(psvHoras) {
      for (let regla of descansosPorPSV) {
        if (psvHoras <= regla.max) return regla.descanso * 60;
      }
      return 24 * 60;
    }

    function llenarSelectHorasMinutos() {
      const horas = [...Array(24).keys()].map(h => String(h).padStart(2, '0'));
      const minutos = [...Array(60).keys()].map(m => String(m).padStart(2, '0'));
      for (let id of ["inicioHora", "finHora"]) {
        const sel = document.getElementById(id);
        horas.forEach(h => sel.add(new Option(h, h)));
      }
      for (let id of ["inicioMin", "finMin"]) {
        const sel = document.getElementById(id);
        minutos.forEach(m => sel.add(new Option(m, m)));
      }
      const selOri = document.getElementById("origen");
      const selDes = document.getElementById("destino");
      const sortedAirports = Object.entries(aeropuertos).sort(([a,], [b,]) => a.localeCompare(b));
      sortedAirports.forEach(([code, info]) => {
        const opt = new Option(`${code} ‚Äì ${info.name}`, code);
        selOri.add(opt.cloneNode(true));
        selDes.add(opt);
      });
    }

    function ajustar(id, delta) {
      const sel = document.getElementById(id);
      const max = id.includes("Hora") ? 23 : 59;
      let val = parseInt(sel.value || 0);
      val = (val + delta + (max + 1)) % (max + 1);
      sel.value = String(val).padStart(2, '0');
    }

    function tiempoEnMinutos(horaStr) {
      const [h, m] = horaStr.split(":").map(Number);
      return h * 60 + m;
    }

    function minutosAHorasYMinutos(minutos) {
      const h = Math.floor(minutos / 60);
      const m = minutos % 60;
      return `${h}h ${m}min`;
    }

    function validarPSV() {
      const tipo = parseInt(document.getElementById("tripulacion").value);
      const ih = parseInt(document.getElementById("inicioHora").value);
      const im = parseInt(document.getElementById("inicioMin").value);
      const fh = parseInt(document.getElementById("finHora").value);
      const fm = parseInt(document.getElementById("finMin").value);
      const vuelo = document.getElementById("tiempoVuelo").value;
      const ori = document.getElementById("origen").value;
      const des = document.getElementById("destino").value;

      if ([ih, im, fh, fm].some(isNaN) || !vuelo || !ori || !des) {
        return document.getElementById("resultado").innerText = "‚ö†Ô∏è Completa todos los campos.";
      }

      let inicio = ih * 60 + im;
      let fin = fh * 60 + fm;
      if (fin < inicio) fin += 1440;

      const durPSV = fin - inicio;
      const vueloMin = tiempoEnMinutos(vuelo);
      const limites = { 2: { hv: 480, psv: 720, ext: 120 }, 3: { hv: 720, psv: 1080, ext: 0 }, 4: { hv: 960, psv: 1200, ext: 0 } };
      const { hv, psv, ext } = limites[tipo];

      const deltaLong = Math.abs(aeropuertos[ori].lon - aeropuertos[des].lon);
      const ajusteDescanso = deltaLong >= 45 ? 120 + Math.floor((deltaLong - 45) / 15) * 30 : 0;

      const descansoBase = calcularDescansoBase(Math.ceil(durPSV / 60));
      const descansoTotal = descansoBase + ajusteDescanso;

      let msg = `üïí PSV: ${minutosAHorasYMinutos(durPSV)}\n`;
      msg += `‚úàÔ∏è Vuelo: ${minutosAHorasYMinutos(vueloMin)}\n`;
      msg += `üåç ŒîLongitud: ${deltaLong.toFixed(2)}¬∞\n`;
      msg += `üõå Descanso m√≠nimo base: ${minutosAHorasYMinutos(descansoBase)}\n`;
      if (ajusteDescanso) {
        msg += `üõå Ajuste por longitud: +${minutosAHorasYMinutos(ajusteDescanso)}\n`;
        msg += `‚úÖ Se ha agregado el per√≠odo de descanso adicional establecido por cambio de longitud geogr√°fica\n`;
      }
      msg += `üõå Descanso total requerido: ${minutosAHorasYMinutos(descansoTotal)}\n\n`;

      msg += durPSV > psv + ext ? `‚ùå PSV excedido (m√°x. ${minutosAHorasYMinutos(psv + ext)})\n` : `‚úÖ PSV dentro de l√≠mite\n`;
      msg += vueloMin > hv ? `‚ùå HV excedido (m√°x. ${minutosAHorasYMinutos(hv)})` : `‚úÖ HV dentro de l√≠mite`;

      document.getElementById("resultado").innerText = msg;
    }

    window.addEventListener("DOMContentLoaded", llenarSelectHorasMinutos);
  </script>

</body>
</html>
