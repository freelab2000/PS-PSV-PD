<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PSV/PS/PD</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#004080" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192x192.png" />
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Figtree', sans-serif;
      background: #f5f8fa;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      color: #1a1a1a;
    }
    h1 {
      text-align: center;
      color: #004080;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input, select {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: 5px;
    }
    .time-group {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    select.time {
      width: 80px;
    }
    button {
      padding: 10px 14px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #004080;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 20px;
    }
    button:hover {
      background-color: #0059b3;
    }
    .resultado {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      font-size: 16px;
      line-height: 1.6;
      border-left: 5px solid #004080;
    }
    .row-group {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 20px;
    }
    .column {
      flex: 1;
    }
    .output-fields {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    input[readonly] {
      background: #f0f0f0;
      text-align: center;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .row-group {
        flex-direction: column;
      }
      .output-fields {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>PSV/PS/PD</h1>
  <div class="row-group">
    <div class="column">
      <label>Block Out</label>
      <div class="time-group">
        <select id="blockInicioHora" class="time" onchange="calcularTiemposVuelo()"></select> :
        <select id="blockInicioMin" class="time" onchange="calcularTiemposVuelo()"></select>
      </div>
    </div>
    <div class="column">
      <label>Air T/O</label>
      <div class="time-group">
        <select id="airInicioHora" class="time" onchange="calcularTiemposVuelo()"></select> :
        <select id="airInicioMin" class="time" onchange="calcularTiemposVuelo()"></select>
      </div>
    </div>
  </div>

  <div class="row-group">
    <div class="column">
      <label>Block In</label>
      <div class="time-group">
        <select id="blockFinHora" class="time" onchange="calcularTiemposVuelo()"></select> :
        <select id="blockFinMin" class="time" onchange="calcularTiemposVuelo()"></select>
      </div>
    </div>
    <div class="column">
      <label>Air LDG</label>
      <div class="time-group">
        <select id="airFinHora" class="time" onchange="calcularTiemposVuelo()"></select> :
        <select id="airFinMin" class="time" onchange="calcularTiemposVuelo()"></select>
      </div>
    </div>
  </div>

  <div class="output-fields">
    <div class="column">
      <label>Block Time</label>
      <input id="blockComputed" readonly />
    </div>
    <div class="column">
      <label>Air Time</label>
      <input id="airComputed" readonly />
    </div>
  </div>

  <label for="origen">Aeropuerto de Origen:</label>
  <select id="origen"></select>

  <label for="destino">Aeropuerto de Destino:</label>
  <select id="destino"></select>

  <label>Inicio PSV:</label>
  <div class="time-group">
    <select id="inicioHora" class="time"></select> :
    <select id="inicioMin" class="time"></select>
  </div>

  <label>T√©rmino PSV:</label>
  <div class="time-group">
    <select id="finHora" class="time"></select> :
    <select id="finMin" class="time"></select>
  </div>

  <label for="tripulacion">Tipo de Tripulaci√≥n:</label>
  <select id="tripulacion">
    <option value="2">2 pilotos</option>
    <option value="3">3 pilotos</option>
    <option value="4">4 pilotos</option>
  </select>

  <button onclick="validarPSV()">Validar</button>

  <div class="resultado" id="resultado">
    <p class="info">Nota: Al Block Time se le agregan 30 minutos para el c√°lculo del per√≠odo de descanso.</p>
    <div id="proximoInicio" class="info" style="margin-top:10px;"></div>
    <div id="validaciones" class="info" style="margin-top:10px;"></div>
    <div id="geoRestInfo" class="info" style="margin-top:10px;"></div>
  </div>
<script>
function calcularTiemposVuelo() {
  const getMins = (hId, mId) => parseInt(document.getElementById(hId).value || 0) * 60 + parseInt(document.getElementById(mId).value || 0);
  let bStart = getMins("blockInicioHora", "blockInicioMin");
  let bEnd = getMins("blockFinHora", "blockFinMin");
  let aStart = getMins("airInicioHora", "airInicioMin");
  let aEnd = getMins("airFinHora", "airFinMin");

  if (bEnd < bStart) bEnd += 1440;
  if (aEnd < aStart) aEnd += 1440;

  let bTime = bEnd - bStart;
  let aTime = aEnd - aStart;

  document.getElementById("blockComputed").value = `${Math.floor(bTime/60)}h ${("0"+(bTime%60)).slice(-2)}min`;
  document.getElementById("airComputed").value = `${Math.floor(aTime/60)}h ${("0"+(aTime%60)).slice(-2)}min`;

  return { bTime, bEnd };
}

function obtenerDescansoDesdeTabla(duracion) {
  if (duracion <= 420) return 600;
  if (duracion <= 480) return 720;
  if (duracion <= 540) return 780;
  if (duracion <= 600) return 840;
  if (duracion <= 660) return 900;
  if (duracion <= 720) return 900;
  if (duracion <= 780) return 900;
  if (duracion <= 840) return 1020;
  if (duracion <= 900) return 1020;
  if (duracion <= 960) return 1080;
  if (duracion <= 1020) return 1140;
  if (duracion <= 1080) return 1200;
  if (duracion <= 1140) return 1320;
  if (duracion <= 1200) return 1440;
  return 1440;
}

function calcularProximoInicioDinamico(bTime, bEnd) {
  let descanso = obtenerDescansoDesdeTabla(bTime);
  let totalMin = bEnd + 30 + descanso;
  let h = Math.floor((totalMin % 1440) / 60);
  let m = totalMin % 60;
  const descansoTexto = `${Math.floor(descanso/60)}h ${("0"+(descanso%60)).slice(-2)}min`;
  document.getElementById("proximoInicio").innerHTML =
    "üïê Pr√≥ximo PSV permitido a partir de: <strong>" + ("0"+h).slice(-2) + ":" + ("0"+m).slice(-2) + "</strong><br>üõå Per√≠odo de descanso requerido: <strong>" + descansoTexto + "</strong>";
}

function validarRestriccionesHV(PSVmin, vueloMin, tripulacion, horaInicioPSV) {
  const limites = {
    2: { hv: 480, psv: 720, nocturna: true },
    3: { hv: 720, psv: 1080, nocturna: false },
    4: { hv: 960, psv: 1200, nocturna: false }
  };

  const limitesTrip = limites[tripulacion];
  let mensajes = [];

  if (vueloMin > limitesTrip.hv) {
    mensajes.push("‚ùå HV excedido (m√°x. " + Math.floor(limitesTrip.hv / 60) + "h)");
  } else {
    mensajes.push("‚úÖ HV dentro de l√≠mite");
  }

  if (PSVmin > limitesTrip.psv) {
    mensajes.push("‚ùå PSV excedido (m√°x. " + Math.floor(limitesTrip.psv / 60) + "h)");
  } else {
    mensajes.push("‚úÖ PSV dentro de l√≠mite");
  }

  if (tripulacion == 2 && (horaInicioPSV >= 1260 || horaInicioPSV < 360)) {
    mensajes.push("‚ö†Ô∏è PSV nocturno detectado entre 21:00 y 06:00. No se permite extensi√≥n.");
  }

  document.getElementById("validaciones").innerHTML = mensajes.join("<br>");
}

function validarPSV() {
  const tripulacion = parseInt(document.getElementById("tripulacion").value || 2);
  const iniHora = parseInt(document.getElementById("inicioHora").value || 0);
  const iniMin = parseInt(document.getElementById("inicioMin").value || 0);
  const finHora = parseInt(document.getElementById("finHora").value || 0);
  const finMin = parseInt(document.getElementById("finMin").value || 0);
  let inicio = iniHora * 60 + iniMin;
  let fin = finHora * 60 + finMin;
  if (fin < inicio) fin += 1440;
  let duracion = fin - inicio;

  const { bTime, bEnd } = calcularTiemposVuelo();
  calcularProximoInicioDinamico(bTime, bEnd);
  validarRestriccionesHV(duracion, bTime, tripulacion, inicio);
  // C√°lculo incremento por longitud geogr√°fica
const geoRestInfoDiv = document.getElementById("geoRestInfo");
geoRestInfoDiv.innerHTML = ""; // Limpiar antes

const origen = document.getElementById("origen").value;
const destino = document.getElementById("destino").value;

const aeropuertos = {
  "CYHZ": -63.5, "CYJT": -58.55, "CYQM": -64.67, "CYQX": -54.57, "CYZX": -64.92,
  "EBBR": 4.48, "EDDF": 8.57, "EHAM": 4.77, "EHRD": 4.43, "GCLP": -15.39,
  "GCTS": -16.57, "GMMN": -7.59, "GOBD": -17.07, "GVAC": -22.60, "GVBA": -22.80,
  "GVNP": -23.52, "GVSV": -25.05, "KBGR": -68.82, "KBOS": -71.01, "KFLL": -80.15,
  "KJFK": -73.78, "KLAX": -118.41, "KMCO": -81.31, "KMIA": -80.29, "KPBI": -80.10,
  "KRSW": -81.76, "LEMD": -3.57, "LEVD": -4.85, "LPAZ": -28.10, "LPLA": -28.33,
  "LPPT": -9.14, "MPTO": -79.38, "MUHA": -82.41, "SACO": -64.21, "SAEZ": -58.53,
  "SAME": -68.78, "SBGR": -46.47, "SBKP": -47.13, "SBRF": -34.91, "SCDA": -70.32,
  "SCEL": -70.79, "SCFA": -70.43, "SCIE": -73.06, "SEGU": -79.88, "SEQM": -78.49,
  "SKBO": -74.15, "SKCL": -76.38, "SKRG": -75.59, "SPHI": -79.83, "SPJC": -77.11
};

if (origen in aeropuertos && destino in aeropuertos) {
  const lon1 = aeropuertos[origen];
  const lon2 = aeropuertos[destino];
  const deltaLon = Math.abs(lon2 - lon1);
  
  if (deltaLon > 45) {
    const extraRestMinutes = 120 + Math.floor((deltaLon - 45) / 15) * 30;
    const horasExtra = Math.floor(extraRestMinutes / 60);
    const minutosExtra = extraRestMinutes % 60;

    geoRestInfoDiv.innerHTML =
      `üåç Se agreg√≥ <strong>+${horasExtra}h ${minutosExtra}min</strong> al per√≠odo de descanso por cambio de longitud geogr√°fica de <strong>${deltaLon.toFixed(1)}¬∞</strong>.`;
  }
}

function cargarAeropuertos() {
  const aeropuertos = [
    { codigo: "CYHZ", nombre: "Halifax" }, { codigo: "CYJT", nombre: "Stephenville" },
    { codigo: "CYQM", nombre: "Moncton" }, { codigo: "CYQX", nombre: "Gander" },
    { codigo: "CYZX", nombre: "Greenwood" }, { codigo: "EBBR", nombre: "Bruselas" },
    { codigo: "EDDF", nombre: "Frankfurt" }, { codigo: "EHAM", nombre: "Amsterdam" },
    { codigo: "EHRD", nombre: "Rotterdam" }, { codigo: "GCLP", nombre: "Gran Canaria" },
    { codigo: "GCTS", nombre: "Tenerife Sur" }, { codigo: "GMMN", nombre: "Casablanca" },
    { codigo: "GOBD", nombre: "Dakar" }, { codigo: "GVAC", nombre: "Sal" },
    { codigo: "GVBA", nombre: "Boa Vista" }, { codigo: "GVNP", nombre: "Praia" },
    { codigo: "GVSV", nombre: "S√£o Vicente" }, { codigo: "KBGR", nombre: "Bangor" },
    { codigo: "KBOS", nombre: "Boston" }, { codigo: "KFLL", nombre: "Fort Lauderdale" },
    { codigo: "KJFK", nombre: "New York" }, { codigo: "KLAX", nombre: "Los Angeles" },
    { codigo: "KMCO", nombre: "Orlando" }, { codigo: "KMIA", nombre: "Miami" },
    { codigo: "KPBI", nombre: "Palm Beach" }, { codigo: "KRSW", nombre: "Fort Myers" },
    { codigo: "LEMD", nombre: "Madrid" }, { codigo: "LEVD", nombre: "Valladolid" },
    { codigo: "LPAZ", nombre: "Santa Maria" }, { codigo: "LPLA", nombre: "Lajes" },
    { codigo: "LPPT", nombre: "Lisboa" }, { codigo: "MPTO", nombre: "Panam√°" },
    { codigo: "MUHA", nombre: "La Habana" }, { codigo: "SACO", nombre: "C√≥rdoba" },
    { codigo: "SAEZ", nombre: "Buenos Aires" }, { codigo: "SAME", nombre: "Mendoza" },
    { codigo: "SBGR", nombre: "Sao Paulo" }, { codigo: "SBKP", nombre: "Campinas" },
    { codigo: "SBRF", nombre: "Recife" }, { codigo: "SCDA", nombre: "Iquique" },
    { codigo: "SCEL", nombre: "Santiago" }, { codigo: "SCFA", nombre: "Antofagasta" },
    { codigo: "SCIE", nombre: "Concepci√≥n" }, { codigo: "SEGU", nombre: "Guayaquil" },
    { codigo: "SEQM", nombre: "Quito" }, { codigo: "SKBO", nombre: "Bogot√°" },
    { codigo: "SKCL", nombre: "Cali" }, { codigo: "SKRG", nombre: "Medell√≠n" },
    { codigo: "SPHI", nombre: "Chiclayo" }, { codigo: "SPJC", nombre: "Lima" }
  ];

  const origen = document.getElementById("origen");
  const destino = document.getElementById("destino");
  aeropuertos.forEach(a => {
    origen.add(new Option(`${a.codigo} ‚Äì ${a.nombre}`, a.codigo));
    destino.add(new Option(`${a.codigo} ‚Äì ${a.nombre}`, a.codigo));
  });
}

window.onload = () => {
  cargarAeropuertos();
  for (let i = 0; i < 24; i++) {
    document.querySelectorAll("select.time").forEach(sel => {
      if (sel.options.length < 24 && sel.id.includes("Hora")) sel.add(new Option(("0"+i).slice(-2), i));
    });
  }
  for (let i = 0; i < 60; i++) {
    document.querySelectorAll("select.time").forEach(sel => {
      if (sel.id.includes("Min")) sel.add(new Option(("0"+i).slice(-2), i));
    });
  }
};
</script>
</body>
</html>
