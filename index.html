<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validación PSV / PD / HV</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#004080" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f2f2f2; color: #000; }
    h1 { color: #004080; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { padding: 5px; width: 100%; max-width: 400px; }
    button { margin-top: 15px; padding: 10px 15px; background-color: #004080; color: white; border: none; cursor: pointer; }
    .resultado { margin-top: 20px; padding: 15px; background: white; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Validación de Períodos de Servicio y Descanso</h1>

  <label for="inicio">Inicio PSV:</label>
  <input type="datetime-local" id="inicio" />

  <label for="fin">Fin PSV:</label>
  <input type="datetime-local" id="fin" />

  <label for="hv">Horas de Vuelo (HV):</label>
  <input type="number" id="hv" step="0.1" />

  <label for="pilotos">Número de Pilotos:</label>
  <select id="pilotos">
    <option value="2">2 pilotos</option>
    <option value="3">3 pilotos</option>
    <option value="4">4 pilotos</option>
  </select>

  <label for="origen">Aeropuerto Origen (ICAO):</label>
  <input type="text" id="origen" />

  <label for="destino">Aeropuerto Destino (ICAO):</label>
  <input type="text" id="destino" />

  <label for="simulador">¿Simulador en Europa?</label>
  <select id="simulador">
    <option value="no">No</option>
    <option value="si">Sí</option>
  </select>

  <button onclick="validar()">Validar</button>

  <div class="resultado" id="resultado"></div>

  <script>
    const aeropuertos = ["kmia", "scel", "saez", "segu", "seqm", "skbo", "mpto", "kbos", "eham", "eddf", "ebbr", "gvac", "gvnp", "saco", "same", "scie", "sbkp", "sbgl", "sbgr", "sbfz", "sbsg", "gclp", "gcts", "gmmn", "lppt", "lemd"];

    function calcularHoras(d1, d2) {
      const ms = new Date(d2) - new Date(d1);
      return ms / (1000 * 60 * 60);
    }

    function getLonDif(origen, destino) {
      const coords = {
        kmia: -80.2906, scel: -70.7938, saez: -58.5358, segu: -78.5083,
        seqm: -78.4870, skbo: -74.1469, mpto: -79.3832, kbos: -71.0052,
        eham: 4.7639, eddf: 8.5706, ebbr: 4.4844, gvac: -23.4833,
        gvnp: -25.0833, saco: -64.2080, same: -68.1136, scie: -72.9562,
        sbkp: -47.1344, sbgl: -43.2506, sbgr: -46.4695, sbfz: -38.5294,
        sbsg: -36.3666, gclp: -15.3846, gcts: -16.5725, gmmn: -7.5899,
        lppt: -9.1280, lemd: -3.5708
      };
      if (!(origen in coords) || !(destino in coords)) return null;
      return Math.abs(coords[origen] - coords[destino]);
    }

    function calcularDescansoExtra(lonDiff) {
      if (lonDiff <= 45) return 0;
      let extra = 2;
      lonDiff -= 45;
      extra += Math.floor(lonDiff / 15) * 0.5;
      return extra;
    }

    function validar() {
      const inicio = document.getElementById("inicio").value;
      const fin = document.getElementById("fin").value;
      const hv = parseFloat(document.getElementById("hv").value);
      const pilotos = parseInt(document.getElementById("pilotos").value);
      const origen = document.getElementById("origen").value.toLowerCase();
      const destino = document.getElementById("destino").value.toLowerCase();
      const simulador = document.getElementById("simulador").value === "si";

      const resultado = document.getElementById("resultado");
      resultado.innerHTML = "";

      if (!inicio || !fin || isNaN(hv)) {
        resultado.innerHTML = "Debe completar todos los campos.";
        return;
      }

      const psv = calcularHoras(inicio, fin);
      let maxHV = 0, maxPSV = 0, maxExt = 0, zonaRoja = false;

      if (pilotos === 2) {
        maxHV = 8;
        maxPSV = 12;
        maxExt = 14;
        zonaRoja = true;
      } else if (pilotos === 3) {
        maxHV = 12;
        maxPSV = 18;
      } else if (pilotos === 4) {
        maxHV = 16;
        maxPSV = 20;
      }

      let msg = `<b>Resultado:</b><br>`;
      msg += `PSV: ${psv.toFixed(2)} h (máx: ${maxPSV}${maxExt ? '-' + maxExt : ''})<br>`;
      msg += `HV: ${hv} h (máx: ${maxHV})<br>`;

      if (hv > maxHV) msg += `<span style='color:red'>Exceso de horas de vuelo</span><br>`;
      if (psv > maxPSV && pilotos === 2 && psv <= maxExt) {
        msg += `<span style='color:orange'>Extensión de PSV aceptada (2 pilotos)</span><br>`;
      } else if (psv > maxPSV) {
        msg += `<span style='color:red'>Exceso en período de servicio</span><br>`;
      }

      if (zonaRoja) {
        const h1 = new Date(inicio).getHours() + new Date(inicio).getMinutes()/60;
        const h2 = new Date(fin).getHours() + new Date(fin).getMinutes()/60;
        const entraZonaRoja = h1 < 5.5 && h1 >= 0.5 || h2 < 5.5 && h2 >= 0.5;
        if (entraZonaRoja && !(simulador && new Date(fin).getHours() <= 2)) {
          msg += `<span style='color:red'>Restricción zona roja (00:30–05:30)</span><br>`;
        }
      }

      const lonDiff = getLonDif(origen, destino);
      if (lonDiff !== null) {
        const extraDescanso = calcularDescansoExtra(lonDiff);
        if (extraDescanso > 0) {
          msg += `∆ Longitud Geográfica: ${lonDiff.toFixed(1)}° → descanso +${extraDescanso} h<br>`;
        }
      } else {
        msg += "<span style='color:orange'>No se pudo calcular ∆ Longitud por falta de datos ICAO</span><br>";
      }

      resultado.innerHTML = msg;
    }
  </script>
</body>
</html>
